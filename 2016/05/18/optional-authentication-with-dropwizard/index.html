<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Optional Authentication With Dropwizard</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="../../../../favicon.ico">

    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="../../../../assets/css/screen.css?v=830db2c5c6" />


    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Dinomite.net" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Optional Authentication With Dropwizard" />
    <meta property="og:description" content="Dropwizard provides a great framework for authentication &amp;amp; authorization.  Authenticators do what their name implies, returning a Principal (probably your User object) that servlets can use for building responses.  The Authorizer interface has a single methoed, authorize(), which takes a Principal and a string role to authorize access for.  These" />
    <meta property="og:url" content="http://localhost:2368/2016/05/18/optional-authentication-with-dropwizard/" />
    <meta property="article:published_time" content="2016-05-18T12:00:00.000Z" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Optional Authentication With Dropwizard" />
    <meta name="twitter:description" content="Dropwizard provides a great framework for authentication &amp;amp; authorization.  Authenticators do what their name implies, returning a Principal (probably your User object) that servlets can use for building responses.  The Authorizer interface has a single methoed, authorize(), which takes a Principal and a string role to authorize access for.  These" />
    <meta name="twitter:url" content="http://localhost:2368/2016/05/18/optional-authentication-with-dropwizard/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Drew Stephens" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Dinomite.net",
        "logo": "http://localhost:2368/ghost/img/ghosticon.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "Drew Stephens",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/d1ed8a9e71adc2b356cfc4e020e0dd0f?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/drew/",
        "sameAs": []
    },
    "headline": "Optional Authentication With Dropwizard",
    "url": "http://localhost:2368/2016/05/18/optional-authentication-with-dropwizard/",
    "datePublished": "2016-05-18T12:00:00.000Z",
    "description": "Dropwizard provides a great framework for authentication &amp;amp; authorization.  Authenticators do what their name implies, returning a Principal (probably your User object) that servlets can use for building responses.  The Authorizer interface has a single methoed, authorize(), which takes a Principal and a string role to authorize access for.  These",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11" />
    <link rel="alternate" type="application/rss+xml" title="Dinomite.net" href="../../../../rss/index.html" />
</head>
<body class="post-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="index.html#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
            <li class="nav-home"><a href="../../../../index.html">Home</a></li>
    </ul>
        <a class="subscribe-button icon-feed" href="../../../../rss/index.html">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
            <a class="menu-button icon-menu" href="index.html#"><span class="word">Menu</span></a>
    </nav>
</header>

<main class="content" role="main">
    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Optional Authentication With Dropwizard</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2016-05-18">18 May 2016</time> 
            </section>
        </header>

        <section class="post-content">
            <p><a href="http://dropwizard.io">Dropwizard</a> provides a great framework for authentication &amp; authorization.  <a href="http://www.dropwizard.io/0.9.2/dropwizard-auth/apidocs/io/dropwizard/auth/Authenticator.html"><code>Authenticator</code></a>s do what their name implies, returning a <a href="http://docs.oracle.com/javase/7/docs/api/java/security/Principal.html?is-external=true"><code>Principal</code></a> (probably your <code>User</code> object) that servlets can use for building responses.  The <a href="http://www.dropwizard.io/0.9.2/dropwizard-auth/apidocs/io/dropwizard/auth/Authorizer.html"><code>Authorizer</code></a> interface has a single methoed, <code>authorize()</code>, which takes a <code>Principal</code> and a string role to authorize access for.  These get wrapped in an <a href="http://www.dropwizard.io/0.9.2/dropwizard-auth/apidocs/io/dropwizard/auth/AuthFilter.html"><code>AuthFilter</code></a> which extracts credentials from the requst and passed on to the <code>Authenticator</code>.</p>

<p>With the authen &amp; authz classes in place protecting resources is easy: you simply annotate them with one of <code>@PermitAll</code>, <code>@RolesAllowed</code>, or <code>@DenyAll</code>.  The last one does exactly what it says on the tin.  A specific role or set of roles can be permitted access with the <code>@RolesAllowed</code> annotation, to which you pass a <code>String</code> or <code>String[]</code> of roles.  <code>@PermitAll</code> allows any <em>authenticated</em> user to access the resource.  What is missing here is an annotation to allow optionally authenticated resources—allowing you to customize a response for a known user but deliver a generic response to anonymous visitors.</p>

<h1 id="optionallyprotectedresources">Optionally protected resources</h1>

<p>The Dropwizard manual gives a <a href="http://www.dropwizard.io/0.9.2/docs/manual/auth.html#protecting-resources">cursory explanation</a> of how to implement optional authentication:</p>

<p><tt> <br />
If you have a resource which is optionally protected (e.g., you want to display a logged-in user’s name but not require login), you need to implement a custom filter which injects a security context containing the principal if it exists, without performing authentication. <br />
</tt></p>

<p>The process for optional resources involves two <code>AuthFilter</code>s: one to check &amp; process credentials for a logged-in user and a second that provides a default user.  These can be hit in turn with a <a href="http://www.dropwizard.io/0.9.2/dropwizard-auth/apidocs/io/dropwizard/auth/chained/ChainedAuthFilter.html"><code>ChainedAuthFilter</code></a>.</p>

<p>I'll show the important parts of how I accomplished this with code examples written in a mix of Java and <a href="https://kotlinlang.org/">Kotlin</a>.</p>

<h1 id="wiring">Wiring</h1>

<p>Setting up Dropwizard's authentication involves creating an <code>AuthFilter</code> to which you pass the <code>Authenticator</code> and <code>Authorizer</code> that it will use.  Creating a <code>ChainedAuthFilter</code> is easy, just pass a <code>List&lt;AuthFilter&gt;</code> with the filters in the order they should be executed.  Dropwizard tries each of the <code>AuthFilter</code>s in turn until one returns successfully.</p>

<p>In the application's <code>run()</code> method:</p>

<pre><code class="language-java">// Application.java
ApiKeyAuthFilter apiKey = new ApiKeyAuthFilter.Builder()  
        .setAuthenticator(apiKeyAuthenticator)
        .setAuthorizer(authorizer)
        .setPrefix("API key")
        .buildAuthFilter();
DefaultAuthFilter default = new DefaultAuthFilter.Builder()  
        .setAuthenticator(defaultAuthenticator)
        .setAuthorizer(authorizer)
        .setPrefix("default")
        .buildAuthFilter();

List&lt;AuthFilter&gt; filterList = Lists.newArrayList(apiKey, default);  
ChainedAuthFilter chainedAuthFilter = new ChainedAuthFilter&lt;&gt;(filterList)

environment.jersey().register(new AuthDynamicFeature(chainedAuthFilter));  
environment.jersey().register(RolesAllowedDynamicFeature.class);  
</code></pre>

<p>The <code>AuthFilter</code>s and their respective <code>Authenticator</code>s are described below.</p>

<h1 id="apikeyauthentication">API key authentication</h1>

<p>As mentioned, my user authentication is done with an API key that is passed in the Authorization HTTP header.  The filter extracts the value and passes it to the <code>authenticate()</code> method of <code>ApiKeyAuthenticator</code>.</p>

<pre><code class="language-java">// ApiKeyAuthFilter.kt
override fun filter(requestContext: ContainerRequestContext) {  
    val credentials = requestContext.headers.getFirst(HttpHeaders.AUTHORIZATION)
    if (!authenticate(requestContext, credentials, API_KEY_AUTH)) {
        throw WebApplicationException(unauthHandler.buildResponse(prefix, realm))
    }
}
</code></pre>

<p>The API key authenticator checks the databse to see if the given API key exists.  If the key is found, the matching <code>User</code> is returned; if not found, an empty <code>Optional</code> is returned instead.</p>

<pre><code class="language-java">// ApiKeyAuthenticator.kt
@Throws(AuthenticationException::class)
override fun authenticate(credentials: ApiKey): Optional&lt;User&gt; {  
    val userId = apiKeyDao.getUserIdForAccessToken(credentials.accessToken)
    if (userId != 0) {
        val user = userDao.getUser(userId)
        return Optional.of(user)
    }

    return Optional.empty&lt;User&gt;()
}
</code></pre>

<h1 id="defaultauthentication">Default authentication</h1>

<p>If API key authentication fails, either because the user provided invalid credentials or no credentials at all, then the next <code>AuthFilter</code> configured in the <code>ChainedAuthFilter</code> is invoked.  Authentication for the default user doesn't actually check anything, so <code>Unit</code> is passed instead of credentials:</p>

<pre><code class="language-java">// DefaultAuthFilter.kt
override fun filter(requestContext: ContainerRequestContext) {  
    if (!authenticate(requestContext, Unit, "DEFAULT")) {
        throw WebApplicationException(unauthHandler.buildResponse(prefix, realm))
    }
}
</code></pre>

<p>As the last authenticator to run in the chain, the DefaultAuthenticator never fails, it simply returns a default-constructed <code>User</code> object.</p>

<pre><code class="language-java">// DefaultAuthenticator.kt
@Throws(AuthenticationException::class)
override fun authenticate(credentials: Unit): Optional&lt;User&gt; {  
    logger.debug("Using default auth");

    val user = User()
    return Optional.of(user)
}
</code></pre>

<h1 id="usageinservlets">Usage in servlets</h1>

<p>The <code>User</code> object looks like this:</p>

<pre><code class="language-java">// User.kt
data class User(val id: Int, roles: List&lt;Role&gt;) : Principal {  
    constructor() : this(0, emptyList())

    init {
        var theRoles = mutableListOf&lt;Role&gt;()

        if (id != 0) theRoles.add(Role.USER)

        roles = theRoles.toList()
    }

    fun hasRole(role: Role): Boolean {
        return roles.contains(role)
    }
}
</code></pre>

<p>Which allows me to check whether valid authentication was provided within a servlet:</p>

<pre><code class="language-java">// SomeResource.kt
fun optionallyAuthenticatedResource(@Context context: SecurityContext) {  
    user = context.getUserPrincipal()

    if (user != null &amp;&amp; user.hasRole(Role.USER)) {
        // Do something for authenticated users
    }

    // Do other stuff for all users
}
</code></pre>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="../../../../author/drew/index.html" style="background-image: url(http://www.gravatar.com/avatar/d1ed8a9e71adc2b356cfc4e020e0dd0f?s&)"><span class="hidden">Drew Stephens's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="../../../../author/drew/index.html">Drew Stephens</a></h4>

                    <p>Read <a href="../../../../author/drew/index.html">more posts</a> by this author.</p>
                <div class="author-meta">
                    
                    
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Optional%20Authentication%20With%20Dropwizard&amp;url=http://localhost:2368/2016/05/18/optional-authentication-with-dropwizard/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/2016/05/18/optional-authentication-with-dropwizard/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:2368/2016/05/18/optional-authentication-with-dropwizard/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>


        </footer>

    </article>
</main>

<aside class="read-next">
    <a class="read-next-story no-cover" href="../../../09/23/diy-stretch-webbing-leash-a-la-ruffwear-roamer/index.html">
        <section class="post">
            <h2>Diy Stretch Webbing Leash a La Ruffwear Roamer</h2>
            <p>The Ruffwear® Roamer™ leash is wonderful for running and great for anytime when you have an enthusiastic dog who&hellip;</p>
        </section>
    </a>
    <a class="read-next-story prev no-cover" href="../../02/reading-devise-sessions-in-java/index.html">
        <section class="post">
            <h2>Reading Devise Sessions In Java</h2>
            <p>I have a Ruby on Rails app that uses Devise for authentication and session management, the latter is really&hellip;</p>
        </section>
    </a>
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="../../../../index.html">Dinomite.net</a> &copy; 2017</section>
            <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.12.0.min.js"></script>
    
    <script type="text/javascript" src="../../../../assets/js/jquery.fitvids.js?v=830db2c5c6"></script>
    <script type="text/javascript" src="../../../../assets/js/index.js?v=830db2c5c6"></script>

</body>
</html>
