<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Reading Devise Sessions In Java</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="../../../../favicon.ico">

    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="../../../../assets/css/screen.css?v=830db2c5c6" />


    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Dinomite.net" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Reading Devise Sessions In Java" />
    <meta property="og:description" content="I have a Ruby on Rails app that uses Devise for authentication and session management, the latter is really done by Warden.  We are making a server-side companion for Ruby written in Kotlin &amp;amp; Java and want to be able to share sessions between the two runtimes. JRuby makes this" />
    <meta property="og:url" content="http://localhost:2368/2016/05/02/reading-devise-sessions-in-java/" />
    <meta property="article:published_time" content="2016-05-02T12:00:00.000Z" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Reading Devise Sessions In Java" />
    <meta name="twitter:description" content="I have a Ruby on Rails app that uses Devise for authentication and session management, the latter is really done by Warden.  We are making a server-side companion for Ruby written in Kotlin &amp;amp; Java and want to be able to share sessions between the two runtimes. JRuby makes this" />
    <meta name="twitter:url" content="http://localhost:2368/2016/05/02/reading-devise-sessions-in-java/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Drew Stephens" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Dinomite.net",
        "logo": "http://localhost:2368/ghost/img/ghosticon.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "Drew Stephens",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/d1ed8a9e71adc2b356cfc4e020e0dd0f?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/drew/",
        "sameAs": []
    },
    "headline": "Reading Devise Sessions In Java",
    "url": "http://localhost:2368/2016/05/02/reading-devise-sessions-in-java/",
    "datePublished": "2016-05-02T12:00:00.000Z",
    "description": "I have a Ruby on Rails app that uses Devise for authentication and session management, the latter is really done by Warden.  We are making a server-side companion for Ruby written in Kotlin &amp;amp; Java and want to be able to share sessions between the two runtimes. JRuby makes this",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11" />
    <link rel="alternate" type="application/rss+xml" title="Dinomite.net" href="../../../../rss/index.html" />
</head>
<body class="post-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="index.html#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
            <li class="nav-home"><a href="../../../../index.html">Home</a></li>
    </ul>
        <a class="subscribe-button icon-feed" href="../../../../rss/index.html">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
            <a class="menu-button icon-menu" href="index.html#"><span class="word">Menu</span></a>
    </nav>
</header>

<main class="content" role="main">
    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Reading Devise Sessions In Java</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2016-05-02">02 May 2016</time> 
            </section>
        </header>

        <section class="post-content">
            <p>I have a Ruby on Rails app that uses <a href="https://github.com/plataformatec/devise">Devise</a> for authentication and session management, the latter is really done by <a href="https://github.com/hassox/warden">Warden</a>.  We are making a server-side companion for Ruby written in <a href="https://kotlinlang.org/">Kotlin</a> &amp; Java and want to be able to share sessions between the two runtimes.</p>

<p><a href="http://jruby.org/">JRuby</a> makes this easy, allowing you to run Ruby on the JVM.  While JRuby supports running entire Ruby applications, for reading sessions we simply want to embed a bit of Ruby within our Java application.  This is accomplished by using <a href="https://github.com/jruby/jruby/wiki/RedBridge">JRuby Embed (AKA Red Bridge)</a>.</p>

<p>First, let's look at the Ruby required to read <a href="http://stackoverflow.com/a/23683925/17339">Warden sessions</a>.  Our app stores sessions in a local databae, so we don't have to deal with encryption or encoding.  If your sessions are stored in cookies, they will be encryptedâ€”<a href="http://nipperlabs.com/rails-secretkeybase">this article</a> should give you what you need to decrypt the session.</p>

<pre><code class="language-ruby">s = Marshal.load(session)  
csrfToken = s['_csrf_token']  
userId = s['warden.user.user.key'][0][0]  
authenticatableSalt = s['warden.user.user.key'][1]  
</code></pre>

<p>The operative part of this is really just one call, <code>Marshal.load(session)</code>.  That invokes Ruby's built-in serializer, <code>Marshal</code>, to deserialize the session string.  The subsequent lines just assign variables to make extracting the desired data in Java easier.  Here is that script used in context to pull the information into Java:</p>

<pre><code class="language-java">public Session getSession(String session) {  
    container.put("session", session);
    container.runScriptlet(rubyScript);

    int userId = ((Long) container.get("userId")).intValue();
    String authenticatableSalt = ((String) container.get("authenticatableSalt"));
    String csrfToken = ((String) container.get("csrfToken"));

    return new Session(userId, authenticatableSalt, csrfToken);
}
</code></pre>

<p>The entire Java class looks like this:</p>

<pre><code class="language-java">import org.jruby.embed.LocalContextScope;  
import org.jruby.embed.LocalVariableBehavior;  
import org.jruby.embed.ScriptingContainer;

public class SessionReader {  
    private final ScriptingContainer container =
        new ScriptingContainer(LocalContextScope.CONCURRENT,
                               LocalVariableBehavior.PERSISTENT);
    private final String script = "s = Marshal.load(session);" +
                                  "csrfToken = s['_csrf_token'];" +
                                  "userId = s['warden.user.user.key'][0][0];" +
                                  "authSalt = s['warden.user.user.key'][1];";

    public Session getSession(String session) {
        container.put("session", session);
        container.runScriptlet(script);

        int userId = ((Long) container.get("userId")).intValue();
        String authSalt = ((String) container.get("authSalt"));
        String csrfToken = ((String) container.get("csrfToken"));
        return new Session(userId, authSalt, csrfToken);
    }
}

class Session {  
    private final int userId;
    private final String authenticatableSalt;
    private final String csrfToken;

    public Session(int userId, String authenticatableSalt, String csrfToken) {
        this.userId = userId;
        this.authenticatableSalt = authenticatableSalt;
        this.csrfToken = csrfToken;
    }
}
</code></pre>

<p>Using <code>LocalContextScope.CONCURRENT</code> allows this class to be threadsafe.  JRuby creates a single runtime and shared variables for the <code>ScriptingContainer</code>, but separate variable mappings for each thread.  The other modifier, <code>LocalVariableBehavior.PERSISTENT</code>, keeps the local variables around after we call <code>runScriptlet()</code> allowing for their retrieval back in Java land.</p>

<p>See the <a href="https://github.com/jruby/jruby/wiki/RedBridgeExamples">Red Bridge Examples</a> for more information on using Ruby within Java.</p>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="../../../../author/drew/index.html" style="background-image: url(http://www.gravatar.com/avatar/d1ed8a9e71adc2b356cfc4e020e0dd0f?s&)"><span class="hidden">Drew Stephens's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="../../../../author/drew/index.html">Drew Stephens</a></h4>

                    <p>Read <a href="../../../../author/drew/index.html">more posts</a> by this author.</p>
                <div class="author-meta">
                    
                    
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Reading%20Devise%20Sessions%20In%20Java&amp;url=http://localhost:2368/2016/05/02/reading-devise-sessions-in-java/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/2016/05/02/reading-devise-sessions-in-java/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:2368/2016/05/02/reading-devise-sessions-in-java/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>


        </footer>

    </article>
</main>

<aside class="read-next">
    <a class="read-next-story no-cover" href="../../18/optional-authentication-with-dropwizard/index.html">
        <section class="post">
            <h2>Optional Authentication With Dropwizard</h2>
            <p>Dropwizard provides a great framework for authentication &amp; authorization.  Authenticators do what their name implies, returning a Principal (probably&hellip;</p>
        </section>
    </a>
    <a class="read-next-story prev no-cover" href="../../../03/18/better-rails/index.html">
        <section class="post">
            <h2>Better Rails</h2>
            <p>Rails provides a caching framework, built-in.  Just set config.cache_store in your application.rb.  The easiest way to&hellip;</p>
        </section>
    </a>
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="../../../../index.html">Dinomite.net</a> &copy; 2017</section>
            <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.12.0.min.js"></script>
    
    <script type="text/javascript" src="../../../../assets/js/jquery.fitvids.js?v=830db2c5c6"></script>
    <script type="text/javascript" src="../../../../assets/js/index.js?v=830db2c5c6"></script>

</body>
</html>
