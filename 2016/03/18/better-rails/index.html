<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Better Rails</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="../../../../favicon.ico">

    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="../../../../assets/css/screen.css?v=91467a1965" />


    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Dinomite.net" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Better Rails" />
    <meta property="og:description" content="Rails provides a caching framework, built-in.  Just set config.cache_store in your application.rb.  The easiest way to use caching is using time-base invalidation—you compute something expensive and store it in the cache with an expiration time.  The first time you try to retrieve it after the expiration," />
    <meta property="og:url" content="http://localhost:2368/2016/03/18/better-rails/" />
    <meta property="article:published_time" content="2016-03-18T12:00:00.000Z" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Better Rails" />
    <meta name="twitter:description" content="Rails provides a caching framework, built-in.  Just set config.cache_store in your application.rb.  The easiest way to use caching is using time-base invalidation—you compute something expensive and store it in the cache with an expiration time.  The first time you try to retrieve it after the expiration," />
    <meta name="twitter:url" content="http://localhost:2368/2016/03/18/better-rails/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Drew Stephens" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Dinomite.net",
        "logo": "http://localhost:2368/ghost/img/ghosticon.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "Drew Stephens",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/d1ed8a9e71adc2b356cfc4e020e0dd0f?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/drew/",
        "sameAs": []
    },
    "headline": "Better Rails",
    "url": "http://localhost:2368/2016/03/18/better-rails/",
    "datePublished": "2016-03-18T12:00:00.000Z",
    "description": "Rails provides a caching framework, built-in.  Just set config.cache_store in your application.rb.  The easiest way to use caching is using time-base invalidation—you compute something expensive and store it in the cache with an expiration time.  The first time you try to retrieve it after the expiration,",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11" />
    <link rel="alternate" type="application/rss+xml" title="Dinomite.net" href="../../../../rss/index.html" />
</head>
<body class="post-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="index.html#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
            <li class="nav-home"><a href="../../../../index.html">Home</a></li>
    </ul>
        <a class="subscribe-button icon-feed" href="../../../../rss/index.html">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
            <a class="menu-button icon-menu" href="index.html#"><span class="word">Menu</span></a>
    </nav>
</header>

<main class="content" role="main">
    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Better Rails</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2016-03-18">18 March 2016</time> 
            </section>
        </header>

        <section class="post-content">
            <p>Rails <a href="http://guides.rubyonrails.org/caching_with_rails.html">provides a caching framework</a>, built-in.  Just set <code>config.cache_store</code> in your <code>application.rb</code>.  The easiest way to use caching is using time-base invalidation—you compute something expensive and store it in the cache with an expiration time.  The first time you try to retrieve it after the expiration, recompute &amp; cache the new value.</p>

<pre><code class="language-ruby">class Product &lt; ActiveRecord::Base  
  def expensive_operation
    Rails.cache.fetch("product/expensive_operation", expires_in: 12.hours) do
      LVMH::API.do_it()
    end
  end
end  
</code></pre>

<p>Many things in the world don't respond well to only being updated on a wallclock schedule.  User profiles are viewed much more often than they are updated, meaning time-based cache expiration will cause needless regeneration of unchanged values.  Furthermore, when a user does update their profile, not seeing that reflected immediately is confusing.</p>

<p>The first problem can be ameliorated by using very long expirations and the latter by force-expiring related cache entries when issuing updates.  That last bit leaves a huge potential pitfall: forgetting to invalidate the cache when updating the value.  Another approach for keeping your cache fresh is to use a quickly-retrieved value that indicates whether the cache needs to be regenerated.</p>

<p>In <a href="http://www.forumforall.net">our</a> application, user profiles show friend relationships and use that information to pull in recent comments from those friends, an expensive operation spanning many tables.  One key bit that informs how much searching we need to do is those friend relationships.  If the user has new friends we need to look at all of those new friend's recent comments and build them for display.  While checking the entire friends list is expensive, checking the latest change for a single user is quick.</p>

<pre><code class="language-ruby">class FriendsAPI  
  def get_friends(user, status)
    key_prefix = "friends_api:get_friends:#{user.id}:#{status}"
    timestamp = user.most_recent_friends_time

    Rails.cache.fetch("#{key_prefix}:#{timestamp}", expires_in: 1.week) do
      Rails.cache.delete_matched("#{key_prefix}:*")

      inflated_friends = []
      friends = user.get_all_friends
      friends.each do |friend|
        inflated_friends &lt;&lt; InflatedFriend.new(friend)
      end

      inflated_friends
    end
  end
end  
</code></pre>

<p>The key here is that <code>user.most_recent_friends_time</code> is a fast query.  The cache key is a compound of the calling-specific values (the user and the requested status) and the timestamp for the most recent friend change time.  When the method is executed, <code>Rails.cache.fetch()</code> attempts to retrieve an entry for the last friend change time.  If the user hasn't created any new friendships since the last time the method ran (and it's been less than <a href="https://www.youtube.com/watch?v=fC_q9KPczAg">one week</a>), it'll be in the cache.  If the user has made more friends, then the cache will miss.  On a miss, the first thing to do is remove any prior entries, then just do the expensive bit and return it.</p>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="../../../../author/drew/index.html" style="background-image: url(http://www.gravatar.com/avatar/d1ed8a9e71adc2b356cfc4e020e0dd0f?s&)"><span class="hidden">Drew Stephens's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="../../../../author/drew/index.html">Drew Stephens</a></h4>

                    <p>Read <a href="../../../../author/drew/index.html">more posts</a> by this author.</p>
                <div class="author-meta">
                    
                    
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Better%20Rails&amp;url=http://localhost:2368/2016/03/18/better-rails/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/2016/03/18/better-rails/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:2368/2016/03/18/better-rails/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>


        </footer>

    </article>
</main>

<aside class="read-next">
    <a class="read-next-story no-cover" href="../../../05/02/reading-devise-sessions-in-java/index.html">
        <section class="post">
            <h2>Reading Devise Sessions In Java</h2>
            <p>I have a Ruby on Rails app that uses Devise for authentication and session management, the latter is really&hellip;</p>
        </section>
    </a>
    <a class="read-next-story prev no-cover" href="../../07/winter-tech-forum-is-the-finest/index.html">
        <section class="post">
            <h2>Winter Tech Forum Is The Finest</h2>
            <p>This past week I was in Crested Butte, Colorado at the second annual Winter Tech Forum. WTF is an&hellip;</p>
        </section>
    </a>
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="../../../../index.html">Dinomite.net</a> &copy; 2017</section>
            <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.12.0.min.js"></script>
    
    <script type="text/javascript" src="../../../../assets/js/jquery.fitvids.js?v=91467a1965"></script>
    <script type="text/javascript" src="../../../../assets/js/index.js?v=91467a1965"></script>

</body>
</html>
